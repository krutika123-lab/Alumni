<% layout("/layouts/boilerplate.ejs") %>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cummins Alumni Portal - Alumni Posts</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Header -->
  <header class="bg-gray-800 p-4 shadow-md sticky top-0">
    <h1 class="text-2xl font-bold text-purple-400 text-center">Cummins Alumni Portal - Post Yourself</h1>
  </header>

  <!-- Form Section -->
  <form action="/alumni/post" method="POST" enctype="multipart/form-data"
        class="max-w-3xl mx-auto mt-6 bg-gray-800 p-6 rounded-xl shadow-lg space-y-4" id="alumniForm">
    <input type="text" name="name" placeholder="Alumni Name" class="w-full p-2 rounded bg-gray-700 text-white" required>
    <input type="text" name="company" placeholder="Company Name" class="w-full p-2 rounded bg-gray-700 text-white" required>
    <input type="email" name="email" placeholder="Email Address" class="w-full p-2 rounded bg-gray-700 text-white" required>
    <input type="text" name="experience" placeholder="Experience (e.g. 5 years)" class="w-full p-2 rounded bg-gray-700 text-white">
    <input type="text" name="skills" placeholder="Skills (comma separated)" class="w-full p-2 rounded bg-gray-700 text-white">
    <input type="file" name="image" accept="image/*" class="w-full text-gray-300">
    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-500 p-2 rounded-lg">Upload Post</button>
  </form>

  <!-- Search Bar -->
  <section class="p-6 max-w-3xl mx-auto">
    <input type="text" id="searchInput" placeholder="Search Alumni by name, company or skill..."
      class="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-600">
  </section>

  <!-- Alumni Cards Section -->
  <section class="p-6">
    <h2 class="text-xl font-semibold text-purple-300 mb-4">Alumni Posts</h2>
    <div id="alumniCards" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      <% if (aalumni && aalumni.length > 0) { %>
        <% aalumni.forEach(a => { %>
          <div class="alumni-card bg-gray-800 p-4 rounded-xl shadow-lg"
               data-search="<%= (a.name || '').toLowerCase() %> <%= (a.company || '').toLowerCase() %> <%= (a.skills && a.skills.length ? a.skills.join(' ') : '').toLowerCase() %>">
            <input type="checkbox" class="mb-2" data-email="<%= a.email || '' %>">
            <img src="<%= a.image || 'https://via.placeholder.com/150' %>"
                 alt="Alumni" class="w-24 h-24 rounded-full mx-auto">
            <h3 class="text-lg font-bold mt-3"><%= a.name || 'Unknown' %></h3>
            <p class="text-gray-300">Company: <%= a.company || 'N/A' %></p>
            <p class="text-gray-300">Email: <%= a.email || 'N/A' %></p>
            <p class="text-gray-300">Experience: <%= a.experience || 'N/A' %></p>
            <p class="text-gray-300">Skills: <%= (a.skills && a.skills.length ? a.skills.join(', ') : 'None') %></p>
          </div>
        <% }) %>
      <% } else { %>
        <p class="text-gray-400">No alumni posts yet. Be the first to add one!</p>
      <% } %>
    </div>
  </section>

  <!-- Email Section -->
  <section class="p-6 bg-gray-800 mt-6 rounded-xl shadow-lg max-w-3xl mx-auto">
    <h2 class="text-xl font-semibold text-purple-300 mb-4">Send Email</h2>
    <textarea id="studentEmails" placeholder="Enter student emails (comma separated)"
      class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white mb-3"></textarea>
    <textarea id="message" placeholder="Enter your message to alumni..."
      class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white mb-3"></textarea>
    <button id="sendEmailBtn"
      class="w-full bg-green-600 hover:bg-green-500 p-3 rounded-lg font-semibold">Send Email to Selected Alumni</button>
    <p id="emailStatus" class="text-sm mt-2 text-gray-300"></p>
  </section>

  <script>
    // Live search
    document.getElementById("searchInput").addEventListener("input", function () {
      const q = this.value.toLowerCase();
      document.querySelectorAll(".alumni-card").forEach(card => {
        card.style.display = card.getAttribute("data-search").includes(q) ? "block" : "none";
      });
    });

    // Send Email
    const btn = document.getElementById("sendEmailBtn");
    const statusEl = document.getElementById("emailStatus");

    btn.addEventListener("click", async () => {
      const studentEmails = document.getElementById("studentEmails").value
        .split(",").map(s => s.trim()).filter(Boolean);
      const message = document.getElementById("message").value.trim();
      const selectedAlumni = [...document.querySelectorAll("input[type=checkbox]:checked")]
        .map(cb => cb.getAttribute("data-email"));

      if (!selectedAlumni.length) return alert("Please select at least one alumni.");
      if (!studentEmails.length) return alert("Please enter student emails.");
      if (!message) return alert("Please enter a message to send.");

      btn.disabled = true;
      statusEl.textContent = "Sending...";

      try {
        const response = await fetch("/alumni/send-email", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest"
          },
          body: JSON.stringify({
            recipients: [...studentEmails, ...selectedAlumni],
            subject: "Alumni Connection",
            message
          })
        });

        const text = await response.text();
        let data;
        try { data = JSON.parse(text); } catch { data = null; }

        if (response.status === 401) {
          alert("Please log in to send emails.");
          window.location.href = "/alumni/login";
          return;
        }

        if (data && data.success) {
          alert("✅ Email sent successfully!");
          statusEl.textContent = "Delivered.";
        } else {
          const errMsg = (data && data.error) ? data.error : "Unexpected server response.";
          alert("❌ Failed to send email: " + errMsg);
          statusEl.textContent = errMsg;
        }
      } catch (err) {
        alert("❌ Error: " + err.message);
        statusEl.textContent = err.message;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
